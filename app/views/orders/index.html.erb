<h1>Договоры</h1>
<%if user_role != "visitor"%>
<%= link_to 'новый договор', new_order_path %> |
   <%end%>
    <%= link_to 'загрузить таблицу в XLS формате', orders_to_xls_path + ".xls" %> | сортировать по:  <%= render 'sort_by'%>

<table id="demotable" class="table table-striped tablesorter">
  <thead>
  <tr class="sort">
    <th> <div id="count" style="text-align: center; color: #000000;"></div> номер</th>
    <th>клиент</th>
    <th>дата заключения</th>
    <th>курс</th>
    <th>преподаватель</th>
    <th>график</th>
    <th>офис</th>
    <th>часы</th>
    <th>начало</th>
    <th>конец</th>
    <th>скидка</th>
    <th> <div id="result" style="text-align: center; color: #000000;"></div> стоимость </th>
    <th>создано</th>
    <th>создал</th>
    <th>отредактировано</th>
    <th>редактировал</th>
    <th></th>
    <th></th>
    <th></th>
    <th></th>
  </tr>
  </thead>
  <tbody>
  <% @orders.each do |order| %>
      <tr class=<%= "tr" if order.price.present?%>>
        <td><%= order.number %></td>
        <td><%= order.client.try(:fio) %></td>
        <td><%= order.contract %></td>
        <td><%= order.course.try(:name) %></td>
        <td><%= order.teacher.try(:fio)%></td>
        <td><%= order.schedule.try(:graphic)%></td>
        <td><%= order.office.try(:name)%></td>
        <td><%= order.schedule.try(:hours)%></td>
        <td><%= order.schedule.try(:start)%></td>
        <td><%= order.schedule.try(:end)%></td>
        <td><%= order.discount %></td>
        <td class="sum"><%=order.price%></td>
        <td><%= order.created_at.strftime("#{formating_month(order.created_at)} %H:%M:%S") %></td>
        <td><%= order.author %></td>
        <td><%= order.updated_at.strftime("#{formating_month(order.updated_at)} %H:%M:%S") %></td>
        <td><%= order.editor %></td>
        <td><%= button_to 'оплата по договору', payment_to_order_path(id: order.id) %></td>
        <td><%= link_to 'см.', order %></td>
        <%if user_role != "visitor"%>
        <td><%= link_to 'ред.', edit_order_path(order) %></td>
        <td><%= link_to 'уд.', order, confirm: 'Вы уверены?', method: :delete %></td>
         <%end%>
      </tr>
  <% end %>
  </tbody>
</table>

<br />

<script>
    var delay = (function(){
        var timer = 0;
        return function(callback, ms){
            clearTimeout (timer);
            timer = setTimeout(callback, ms);
        };
    })();
    $(document).ready(function() {
        var res=0;
        var count =0;
        $('.tr').each(function(){
            if ( getComputedStyle(this,null).display != "none") {
                res += parseFloat($(this).find(".sum").html());
            }
        });
        $('tbody tr').each(function(){
            if ( getComputedStyle(this,null).display != "none") {
                count+=1;
            }
        });
        $('#result').text(res);
        $('#count').text(count);

        $('input').keyup(function() {
            delay(function(){
                var res=0;
                var count =0;
                $('.tr').each(function(){
                    if ( getComputedStyle(this,null).display != "none") {
                        res += parseFloat($(this).find(".sum").html());
                    }
                });
                $('tbody tr').each(function(){
                    if ( getComputedStyle(this,null).display != "none") {
                        count+=1;
                    }
                });
                $('#result').text(res);
                $('#count').text(count);
            }, 350 );
        });


    });

</script>
